name: dual-agent

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # alle 6 Stunden

jobs:
  worker:
    name: Worker (Mersenne + Steel + Groq)
    runs-on: ubuntu-latest
    environment: General
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install browser-use langchain-groq
          fi

      # Advice aus dem letzten Run laden (falls vorhanden)
      - name: Download social advice (if exists)
        uses: actions/download-artifact@v4
        with:
          name: social-advice
          path: social-advice
        continue-on-error: true

      - name: Run core agent (worker)
        env:
          STEEL_API_KEY: ${{ secrets.STEEL_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
          EMAIL_APP_PASSWORD: ${{ secrets.EMAIL_APP_PASSWORD }}
          TARGET_URL: ${{ secrets.TARGET_URL }}
          TARGET_USER: ${{ secrets.TARGET_USER }}
          TARGET_PW: ${{ secrets.TARGET_PW }}
          ADVICE_FILE: social-advice/advice.md
          WORKER_TIMEOUT_SEC: "240"
        run: |
          mkdir -p worker-report
          python agent_core.py | tee worker-report/run.log

      - name: Upload worker artifacts
        uses: actions/upload-artifact@v4
        with:
          name: worker-report
          path: worker-report
          if-no-files-found: warn


  social:
    name: Social (Moltbook prep + Advice)
    runs-on: ubuntu-latest
    environment: General
    needs: worker
    timeout-minutes: 8

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download worker artifacts
        uses: actions/download-artifact@v4
        with:
          name: worker-report
          path: worker-report

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install python deps (social)
        run: |
          python -m pip install --upgrade pip
          pip install langchain-groq

      - name: Fetch Moltbook skill.md (follow redirects)
        run: |
          curl -fsSL -L https://moltbook.com/skill.md -o moltbook_skill.md
          echo "skill.md fetched:"
          head -n 30 moltbook_skill.md || true

      - name: Create social artifacts (advice + post)
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          WORKER_LOG: worker-report/run.log
          SKILL_MD: moltbook_skill.md
        run: |
          python agent_social.py

      - name: Upload social advice artifact
        uses: actions/upload-artifact@v4
        with:
          name: social-advice
          path: advice.md
          if-no-files-found: warn

      - name: Upload social artifacts
        uses: actions/upload-artifact@v4
        with:
          name: social-output
          path: |
            moltbook_skill.md
            social_post.md
            advice.md
          if-no-files-found: warn
